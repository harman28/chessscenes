<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chess Scenes</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!--=============================================================================
  LOCATION DATA
  Edit this section to add or update places.

  Each entry is a block of key: value lines separated by blank lines.

  Supported keys:
    name:         Display name (required)
    labels:       Comma-separated labels, e.g: chess bar, chess club
    coordinates:  lat, lng  (required)
    note:         Short description shown on cards and popups
    link:         URL to Google Maps or similar
    image:        URL to a photo shown in the map popup (jpg, png, etc.)
    city:         City name (optional, shown on card)
    days:         Comma-separated days active, e.g: Monday, Wednesday
                  Omit entirely if active every day (or day-irrelevant)

  Known labels and their colors/icons:
    chess board   → green   ♟  (outdoor boards, giant sets)
    chess shop    → blue    ♛  (retailers)
    chess memorial → purple ♔  (historic sites, defunct venues)
    chess bar     → red     ♞  (bars/cafes with regular chess)
    chess club    → brown   ♜  (organised clubs)
    chess meetup  → teal    ♝  (informal recurring meetups)

  Add a new location by copying a block below and editing the values.
  Leave a blank line between entries.
==============================================================================

name: Former Cafe Gambit
labels: chess memorial
city: Amsterdam
coordinates: 52.3755148120896, 4.882690917303496
note: Defunct chess bar.
link: https://maps.app.goo.gl/AtdP5dHQVRihL9yt8

name: Former Max Euwe Schaakhuis
labels: chess memorial
city: Amsterdam
coordinates: 52.368472045937146, 4.8712247131282576
link: https://maps.app.goo.gl/NkxYzuvTdSqDzWNh9

name: Zwart op Wit
labels: chess club
city: Amsterdam
coordinates: 52.37107776390779, 4.866202094898311
note: Meets every Monday evening at 8pm in the basement of games cafe 2 Klaveren.
link: https://maps.app.goo.gl/2iYpS9ALfHsJLAwYA
days: Monday

name: Schaakvereniging Amsterdam West
labels: chess club
city: Amsterdam
coordinates: 52.371848184945364, 4.868834031296687
note: Meets every Thursday evening at 8pm in Bilderdijkpark.
link: https://maps.app.goo.gl/HE7btnNk4Bit5ywy8
days: Thursday

name: Schaakvereniging Caissa
labels: chess club
city: Amsterdam
coordinates: 52.353211646390925, 4.883298807309834
note: Meets every Tuesday evening at 8pm in Huize Lydia.
link: https://maps.app.goo.gl/cnJ446iJsELTRz7XA
days: Thursday

name: Schaakvereniging EsPion
labels: chess club
city: Amsterdam
coordinates: 52.345217583410495, 4.9085327618301156
note: Meets every Monday evening at Gaaspstraat 8.
link: https://maps.app.goo.gl/dZG9V7rcx1a9q3rLA
days: Monday

name: De Queer Schaakclub
labels: chess club
city: Amsterdam
coordinates: 52.354412053333895, 4.854522492054707
note: Meets every Wednesday evening at Speelzaal KLUP.
link: https://maps.app.goo.gl/4hLHEWU5ktfCiWCXA
days: Wednesday

name: De Volewijckers
labels: chess club
city: Amsterdam
coordinates: https://maps.app.goo.gl/mqUyi83fLoGxKCwi8
note: Chess club De Volewijckers plays every Wednesday evening in the think sports center Het Zwanenmeer.
link: https://maps.app.goo.gl/mqUyi83fLoGxKCwi8
days: Wednesday

name: Cafe de Laurierboom
labels: chess bar
city: Amsterdam
coordinates: 52.372347065141824, 4.880934681011202
note: Chess mecca of Amsterdam. Tournaments on barblitz.co. Casual chess always.
link: https://maps.app.goo.gl/PizEC9TRQ4kt8QyK6

name: Max Euwe Centrum
labels: chess club
city: Amsterdam
coordinates: 52.362777166541285, 4.882811878673435
note: Free chess museum and library.
days: Tuesday, Wednesday, Thursday, Friday, Saturday

name: Max Euweplein
labels: chess memorial, chess board
city: Amsterdam
coordinates: 52.362969674148395, 4.88370529837886
note: Square named after former Dutch World Champion. 5 outdoor chess tables and a memorial.
link: https://maps.app.goo.gl/BdbA8DiMEQxf37us9

name: Chess & Beer
labels: chess meetup
city: Amsterdam
coordinates: 52.363208136727685, 4.882977053882178
note: Casual chess meetup every second Sunday afternoon in Cafe De Balie.
link: https://maps.app.goo.gl/bkpboKbMJeadL65F6
days: Sunday

name: Vondelbunker Chess
labels: chess meetup
city: Amsterdam
coordinates: 52.36093601496312, 4.87757042744756
note: Underground chess on Sunday afternoons. Irregular.
link: https://maps.app.goo.gl/zVaGJ4eQ19HZ6h6z8
days: Sunday

name: Het Paard
labels: chess shop
city: Amsterdam
coordinates: 52.38410008633985, 4.885394165335662
note: Notable chess shop.
link: https://maps.app.goo.gl/ycLy5MS6BBYACa3z9

name: Chess Art
labels: chess memorial, chess board
city: Amsterdam
note: 5 chessboards in a step formation, one with carved pieces. One board is at a comfortable playing height.
image: https://i.imgur.com/e8Y9KwR.jpeg
coordinates: 52.38502130682298, 4.882785843172775

name: Chess Table
labels: chess board
city: Amsterdam
coordinates: 52.38471574220395, 4.8855323401516735
note: Abandoned outdoor chess tables.
link: https://maps.app.goo.gl/Pt2zN4pDBFiQ8ddx8

name: Chess Table
labels: chess board
city: Amsterdam
coordinates: 52.367397288232056, 4.876081661186785
note: Abandoned outdoor chess tables.
link: https://maps.app.goo.gl/cDYhY7noTk7SDkwYA

name: Giant Chess Board
labels: chess board
city: Amsterdam
coordinates: 52.36404452205097, 4.866087393855511
note: Giant board at the corner of the playground. Pieces locked in the steel boxes.
link: https://maps.app.goo.gl/N9mAaZdBsfyAJDEW6

name: Schaaktafels
labels: chess board, chess meetup
city: Utrecht
coordinates: 52.097663330948684, 5.022259352304256
note: Chess tables in Maximapark. Meetup on Sunday mornings.
link: https://maps.app.goo.gl/Dx121rmGCnhm935N8

name: Schaakcafe Utrecht
labels: chess club, chess bar, chess meetup
city: Utrecht
coordinates: 52.09976268371182, 5.103186467326744
note: Every Friday afternoon from 13:30 onwards till 17:00.
link: https://maps.app.goo.gl/j7A7ARS1a3TbcKLk6

name: Giant Chess Board
labels: chess board
city: Amsterdam
coordinates: 52.36404452205097, 4.866087393855511
note: Giant board at the corner of the playground. Pieces locked in the steel boxes.
link: https://maps.app.goo.gl/N9mAaZdBsfyAJDEW6

name: Giant Chess Board
labels: chess board
city: Leiden
coordinates: 52.16364644160096, 4.484094054330104
note: Giant chess board next to the museum
link: https://maps.app.goo.gl/BcBadmCYz656qFpC9

name: Giant Chess Board
labels: chess board
city: Gouda
coordinates: 52.014704997613464, 4.710622070431268
note: Mini-giant board, next to a small church.
link: https://maps.app.goo.gl/rSX32znHBznR2ZHd8

name: Stichting En Passant
labels: chess club, chess bar
city: The Hague
coordinates: 52.07432068089482, 4.311602878673388
note: Chess on weekends.
link: https://maps.app.goo.gl/2A2fRFpQfjugkGRg9
days: Friday, Saturday, Sunday

name: KopieKoffie
labels: chess meetup
city: Delft
coordinates: 52.00047872546669, 4.3460540624039785
note: Chess on Sundays at 3.30pm.
link: https://maps.app.goo.gl/zz2rpLMpYdpqykU98
days: Sunday

name: Buurtcentrum Gentbrugge
labels: chess meetup
city: Ghent
coordinates: 51.04301894619833, 3.7440072254320547
note: Chess Sunday 10am to 1pm
link: https://www.google.com/maps/place/Buurtcentrum+Gentbrugge/data=!4m2!3m1!1s0x47c376ac3bdee5a9:0xf8a369ab94002198
days: Sunday

name: Le Pantin
labels: chess bar
city: Brussels
coordinates: 50.82892801179286, 4.371377076665836
note: Blitz tournament Tuesdays at 7pm.
link: https://www.google.com/maps/place/Le+Pantin/data=!4m2!3m1!1s0x47c3c4931d8affd3:0xca234321219fd876

name: Le STROF
labels: chess bar
coordinates: 50.843288815803355, 4.351961345144561
city: Brussels
note: Genuine chess bar.
link: https://www.google.com/maps/place/Le+STROF/data=!4m2!3m1!1s0x47c3c5c725189a65:0xb28bd2bfe00ee30d

name: Toots Jazz Club
labels: chess bar
coordinates: 50.847190853915144, 4.353162974733196
city: Brussels
note: Blitz event Tuesdays at 7.30pm. Get there early.
link: https://www.google.com/maps/place/Toots+Jazz+Club/data=!4m2!3m1!1s0x47c3c57b380641c5:0x20518f8f20b019ae
days: Tuesday

name: St John's Square
labels: chess meetup
city: London
coordinates: 51.53733210186295, -0.11475202081671028
note: Chess on Saturday at 12pm.
link: https://www.google.com/maps/place/St+John's+Square/data=!4m2!3m1!1s0x48761b51aeec49ad:0xb0b1c14fb1973add
days: Saturday

name: Granary Square
labels: chess meetup
city: London
coordinates: 51.53733210186295, -0.11475202081671028
note: Chess on Wednesday at 6.30pm.
link: https://www.google.com/maps/place/Granary+Square/data=!4m2!3m1!1s0x48761b3d9035396b:0x87d7405a11148df9
days: Wednesday

name: Old Brewery
labels: chess bar
coordinates: 51.48613189677573, -0.0011239949974221996
city: London
note: Chess here on Sundays 12–5.
link: https://www.google.com/maps/place/Old+Brewery/data=!4m2!3m1!1s0x48760284d129d219:0xfc03125988dcf0bd
days: Sunday

name: Giant Chess Board
labels: chess board
city: London
coordinates: 51.51438397011346, -0.2056662758887658
link: https://maps.app.goo.gl/EtMV8xhohTBEa94s6

name: Club d'Echecs Luxembourg 1915
city: Luxembourg
labels: chess club
coordinates: 49.60455003720618, 6.1320267369725014
note: Chess on Tuesday and Friday at 8pm at Café chez Maria
link: https://www.google.com/maps/place/Club+d'Echecs+Luxembourg+1915/data=!4m2!3m1!1s0x479548d6c89dd013:0xbcdef2a3c4fbabdb
days: Tuesday, Friday

name: Satranc 2000
city: Cologne
labels: chess meetup
coordinates: 50.945800573829075, 6.932950523082612
note: Chess on the 1st and 3rd Saturday of the month, 3pm at Naturfreundehaus.
link: https://www.google.com/maps/place/Naturfreundehaus/data=!4m2!3m1!1s0x47bf250fd1afc9d9:0x2d154958bf90c4f
days: Saturday

name: Copenhagen Chess
city: Copenhagen
labels: chess meetup
coordinates: 55.68314648081195, 12.540781316342184
note: Casual chess on Wednesday and Saturday afternoons.
link: https://www.google.com/maps/place/Copenhagen+Chess/data=!4m2!3m1!1s0x465253bb1578f14b:0xe54306844d593f1b
days: Wednesday, Saturday

name: Svarta Hästen Stureplan
labels: chess bar
city: Stockholm
coordinates: 59.33737559447111, 18.07269906268197
note: Chess and wine bar.
days: Wednesday, Thursday, Friday, Saturday, Sunday
link: https://www.google.com/maps/place/Svarta+H%C3%A4sten+Stureplan/data=!4m2!3m1!1s0x465f9dbc578f796f:0x53a5b5f15a5796ae

name: The Good Knight
city: Oslo
labels: chess bar
coordinates: 59.93430513100195, 10.863946284474302
days: Monday, Tuesday, Wednesday, Thursday, Friday, Saturday
note: Just a chess bar.
link: https://www.google.com/maps/place/The+Good+Knight/data=!4m2!3m1!1s0x46416f595815fb39:0x8b0371b4e7a9f52f

name: StrangerChess
labels: chess meetup
coordinates: 52.525077432725524, 13.411217636212005
city: Berlin
note: 7pm.
link: https://www.google.com/maps/place/StrangerChess/data=!4m2!3m1!1s0x47a85161b51f0f59:0xe606b5e5c59ad757

name: Babylon
labels: chess meetup
coordinates: 52.52627849017091, 13.4128913345676
city: Berlin
note: Chess every night at 7pm.
link: https://www.google.com/maps/place/Babylon/data=!4m2!3m1!1s0x47a84e1dd8daaaab:0x319941efa11046b4

name: Gambit Cafe&Bar
labels: chess bar
city: Prague
coordinates: 50.09660180414321, 14.462408325506006
note: Lots of chess events, casual chess on Wednesdays
link: https://www.google.com/maps/place/Gambit+Cafe%26Bar/data=!4m2!3m1!1s0x470b950035457b29:0xbee0bb0cfc3a7b6b
days: Wednesday

name: B4 | CAFÉ PUB
labels: chess bar
coordinates: 50.093351027794796, 14.426911206310468
city: Prague
note: Chess-themed pub
link: https://www.google.com/maps/place/B4+%7C+CAF%C3%89+PUB/data=!4m2!3m1!1s0x470b959bff609865:0x8f30083f05fa09da

name: Wilhelm Steinitz' commemorative plaque
city: Prague
labels: chess memorial
coordinates: 50.09081803049813, 14.415753217273151
note: Commemorative plaque for the first chess world champion.
link: https://www.google.com/maps/place/Wilhelm+Steinitz',+the+first+chess+world+champion's+commemorative+plaque/data=!4m2!3m1!1s0x470b95f5d8bc8f3d:0xe412bc3bd6b6b444

name: Barcelona Chess Meetup
labels: chess meetup
city: Barcelona
coordinates: 41.38916982601849, 2.187669756717959
note: Barcelona Chess Meetup meets here on the playground on Sundays in the Summer. Meet at the NorthWest gate at 5pm.
link: https://www.google.com/maps/place/Playground/data=!4m2!3m1!1s0x12a4a36fb070aba7:0xc343311540d5a6b4
days: Sunday

name: Barcelona Chess Meetup
city: Barcelona
labels: chess meetup
coordinates: 41.382486761448384, 2.180746607742904
note: Barcelona Chess Meetup meets at Mehman Khanna Halal on Sundays in the Winter.
link: https://www.google.com/maps/place/Mehman+Khanna+Halal+%7C+Barcelona/data=!4m2!3m1!1s0x12a4a36d9f9f1517:0x8e6289a1446950dc
days: Sunday

name: Piazza degli Scacchi
labels: chess memorial
city: Marostica
coordinates: 45.75087995062626, 11.655548131331718
note: A human-scale chess game (Partita a Scacchi) is acted out in medieval costume on the second weekend of September in even-numbered years.
link: https://www.google.com/maps/place/Piazza+degli+Scacchi/data=!4m2!3m1!1s0x4778cfd5352dbd85:0x431c53b90c66ae66

name: Blitz Society
labels: chess bar
city: Paris
coordinates: 48.85309115846211, 2.331505957041081
link: https://www.google.com/maps/place/Blitz+Society/data=!4m2!3m1!1s0x47e6716dc5a5bb15:0xf1333a977c5f335f


-->

<style>
  :root {
    --cream: #f5f0e8;
    --ink: #1a1208;
    --gold: #c9a84c;
    --gold-light: #e8d98a;
    --brown: #4a3520;
    --muted: #7a6a55;
    --white: #fdfaf4;
    --border: #d4c5a9;
    --bg-light: #ede8de;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    height: 100%;
    overflow: hidden;
  }

  body {
    background: var(--cream);
    color: var(--ink);
    font-family: 'IBM Plex Mono', monospace;
    display: flex;
    flex-direction: column;
  }

  /* ── HEADER ── */
  header {
    background: var(--ink);
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
  }

  .header-chess-bg {
    position: absolute;
    inset: 0;
    opacity: 0.045;
    background-image: repeating-conic-gradient(var(--cream) 0% 25%, transparent 0% 50%);
    background-size: 28px 28px;
  }

  .header-inner {
    position: relative;
    display: flex;
    align-items: center;
    padding: 14px 28px;
    gap: 12px;
  }

  .king-icon { font-size: 1.7rem; line-height: 1; user-select: none; }

  .header-title h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(1.25rem, 2.5vw, 1.75rem);
    font-weight: 900;
    color: var(--cream);
    letter-spacing: -0.3px;
  }

  .header-title .subtitle {
    font-size: 0.6rem;
    color: var(--gold);
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-top: 2px;
  }

  /* ── CITY FILTER (list view only) ── */
  .city-controls {
    display: none;
    background: #1e1a0e;
    border-top: 1px solid rgba(255,255,255,0.05);
    padding: 7px 28px;
    gap: 10px;
    align-items: center;
    flex-shrink: 0;
  }

  body.is-list .city-controls { display: flex; }

  .city-select {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.7);
    padding: 4px 28px 4px 10px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.63rem;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 2px;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='rgba(255,255,255,0.4)'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 9px center;
    transition: border-color 0.13s;
  }

  .city-select:focus { outline: none; border-color: var(--gold); }
  .city-select option { background: #1a1208; color: white; text-transform: none; }

  /* ── SUBMISSION MODAL ── */
  .modal-backdrop {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(10, 8, 4, 0.75);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal-backdrop.open { display: flex; }

  .modal {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 3px;
    width: 100%;
    max-width: 480px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 12px 48px rgba(0,0,0,0.4);
  }

  .modal-header {
    background: var(--ink);
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
  }

  .modal-header h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.05rem;
    color: var(--cream);
    font-weight: 700;
  }

  .modal-close {
    background: none;
    border: none;
    color: rgba(255,255,255,0.5);
    font-size: 1.2rem;
    cursor: pointer;
    line-height: 1;
    padding: 2px 4px;
    transition: color 0.13s;
  }
  .modal-close:hover { color: white; }

  .modal-body { padding: 22px 22px 26px; }

  .modal-body p {
    font-size: 0.65rem;
    color: var(--muted);
    line-height: 1.6;
    margin-bottom: 18px;
    letter-spacing: 0.3px;
  }

  .form-row { margin-bottom: 14px; }

  .form-row label {
    display: block;
    font-size: 0.58rem;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 5px;
  }

  .form-row label .req { color: var(--gold); }

  .form-row input,
  .form-row textarea,
  .form-row select {
    width: 100%;
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 8px 10px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.68rem;
    color: var(--ink);
    transition: border-color 0.13s;
  }

  .form-row input:focus,
  .form-row textarea:focus,
  .form-row select:focus {
    outline: none;
    border-color: var(--gold);
  }

  .form-row textarea { resize: vertical; min-height: 70px; }

  .form-row select { appearance: none; cursor: pointer; }

  .toggle-group {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 2px;
  }

  .toggle-btn {
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 5px 10px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.62rem;
    letter-spacing: 0.5px;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.13s;
    user-select: none;
  }

  .toggle-btn:hover {
    border-color: var(--gold);
    color: var(--ink);
  }

  .toggle-btn.active {
    background: var(--ink);
    border-color: var(--ink);
    color: var(--gold);
  }

  .form-hint {
    font-size: 0.55rem;
    color: var(--border);
    letter-spacing: 0.5px;
    text-transform: none;
    font-weight: normal;
  }

  .form-submit {
    width: 100%;
    background: var(--ink);
    color: var(--gold);
    border: none;
    padding: 11px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.68rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 2px;
    margin-top: 6px;
    transition: background 0.13s;
  }

  .form-submit:hover { background: var(--brown); }
  .form-submit:disabled { opacity: 0.45; cursor: not-allowed; }

  .form-msg {
    margin-top: 12px;
    font-size: 0.63rem;
    padding: 8px 10px;
    border-radius: 2px;
    display: none;
  }
  .form-msg.success { display: block; background: #e8f5e9; color: #2d6a4f; border: 1px solid #a5d6a7; }
  .form-msg.error   { display: block; background: #fdecea; color: #8b2500; border: 1px solid #f5a79c; }
  .form-msg.warn    { display: block; background: #fff8e1; color: #5c4a00; border: 1px solid #ffe082; }

  /* ── SUBMIT BUTTON in header ── */
  .suggest-btn {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.55);
    padding: 4px 11px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.58rem;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.13s;
    white-space: nowrap;
  }
  .suggest-btn:hover { color: white; border-color: rgba(255,255,255,0.45); }

  /* ── DAY FILTER ROW (list view only) ── */
  .day-controls {
    display: none; /* hidden by default; shown only in list view */
    background: #252010;
    border-top: 1px solid rgba(255,255,255,0.05);
    padding: 7px 28px;
    gap: 7px;
    align-items: center;
    flex-wrap: wrap;
    flex-shrink: 0;
  }

  .day-controls .filter-btn {
    font-size: 0.6rem;
  }

  .day-controls .filter-btn.active {
    background: #e8a020;
    border-color: #e8a020;
    color: var(--ink);
  }

  body.is-list .day-controls { display: flex; }

  /* ── CARD DAY BADGES ── */
  .card-days {
    display: flex;
    flex-wrap: wrap;
    gap: 3px;
    margin-top: 6px;
  }

  .card-day {
    font-size: 0.53rem;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    padding: 2px 6px;
    border-radius: 1px;
    background: rgba(0,0,0,0.07);
    color: var(--muted);
    border: 1px solid var(--border);
  }

  .card-day.is-today {
    background: #e8a020;
    color: white;
    border-color: #e8a020;
  }

  /* ── POPUP DAY BADGES ── */
  .popup-days {
    display: flex;
    flex-wrap: wrap;
    gap: 3px;
    margin-top: 5px;
  }

  .popup-day {
    font-size: 0.5rem;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    padding: 1px 5px;
    border-radius: 1px;
    background: rgba(0,0,0,0.07);
    color: var(--muted);
    border: 1px solid var(--border);
  }

  .popup-day.is-today {
    background: #e8a020;
    color: white;
    border-color: #e8a020;
  }

  /* ── CONTROLS ── */
  .controls {
    background: var(--ink);
    border-top: 1px solid rgba(255,255,255,0.07);
    padding: 9px 28px;
    display: flex;
    gap: 7px;
    align-items: center;
    flex-wrap: wrap;
    flex-shrink: 0;
  }

  .filter-label {
    font-size: 0.58rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--gold);
    margin-right: 3px;
    white-space: nowrap;
  }

  .filter-btn {
    border: 1px solid rgba(255,255,255,0.16);
    background: transparent;
    color: rgba(255,255,255,0.5);
    padding: 4px 10px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.63rem;
    letter-spacing: 0.8px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.13s;
    border-radius: 2px;
    display: flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
    user-select: none;
  }

  .filter-btn .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .filter-btn:hover {
    color: rgba(255,255,255,0.85);
    border-color: rgba(255,255,255,0.35);
  }

  .filter-btn.active {
    background: var(--gold);
    border-color: var(--gold);
    color: var(--ink);
  }

  .controls-right {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  #count-badge {
    font-size: 0.58rem;
    color: rgba(255,255,255,0.35);
    letter-spacing: 1px;
    white-space: nowrap;
  }

  .view-toggle { display: flex; gap: 3px; }

  .view-btn {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.18);
    color: rgba(255,255,255,0.45);
    width: 30px; height: 30px;
    cursor: pointer;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.13s;
    border-radius: 2px;
  }

  .view-btn.active {
    background: var(--gold);
    border-color: var(--gold);
    color: var(--ink);
  }

  /* ── MAIN LAYOUT ── */
  .main {
    flex: 1;
    display: flex;
    min-height: 0;
    overflow: hidden;
  }

  /* ── MAP ── */
  #map {
    flex: 1;
    min-width: 0;
    z-index: 1;
  }

  /* ── SIDEBAR ── */
  .sidebar {
    width: 340px;
    min-width: 340px;
    background: var(--white);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-header {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 0.58rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    background: var(--bg-light);
    flex-shrink: 0;
  }

  .sidebar-scroll {
    overflow-y: auto;
    flex: 1;
  }

  .sidebar-scroll::-webkit-scrollbar { width: 3px; }
  .sidebar-scroll::-webkit-scrollbar-thumb { background: var(--border); }

  /* ── LIST VIEW ── */
  .main.is-list #map { display: none; }
  .main.is-list .sidebar {
    width: 100%;
    min-width: 0;
    border-left: none;
    background: var(--cream);
    overflow-y: auto;
  }
  .main.is-list .sidebar-header { display: none; }
  .main.is-list .sidebar-scroll {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(290px, 1fr));
    gap: 14px;
    padding: 22px;
    align-content: start;
    overflow: visible;
  }

  /* ── CARDS ── */
  .location-card {
    padding: 13px 16px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.1s;
    position: relative;
  }

  .location-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: transparent;
    transition: background 0.13s;
  }

  .location-card:hover { background: var(--bg-light); }
  .location-card:hover::before { background: var(--gold); }
  .location-card.highlighted { background: #fef9ee; }
  .location-card.highlighted::before { background: var(--gold); }

  /* List-view card overrides */
  .main.is-list .location-card {
    border: 1px solid var(--border);
    border-radius: 3px;
    background: var(--white);
    box-shadow: 0 1px 6px rgba(0,0,0,0.06);
    padding: 15px 17px;
  }

  .main.is-list .location-card::before {
    border-radius: 3px 0 0 3px;
  }

  .card-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-bottom: 7px;
  }

  .card-tag {
    font-size: 0.55rem;
    letter-spacing: 1px;
    text-transform: uppercase;
    padding: 2px 7px;
    border-radius: 1px;
    font-weight: 500;
    color: white;
    white-space: nowrap;
  }

  .card-city {
    font-size: 0.58rem;
    color: var(--muted);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    margin-bottom: 3px;
  }

  .card-name {
    font-family: 'Playfair Display', serif;
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--ink);
    line-height: 1.3;
    margin-bottom: 5px;
  }

  .card-note {
    font-size: 0.66rem;
    color: var(--muted);
    line-height: 1.55;
    margin-bottom: 7px;
  }

  .card-link {
    font-size: 0.6rem;
    color: var(--gold);
    text-decoration: none;
    letter-spacing: 1px;
    text-transform: uppercase;
    border-bottom: 1px solid var(--gold-light);
    padding-bottom: 1px;
    transition: color 0.13s;
  }
  .card-link:hover { color: var(--brown); }

  .no-results {
    padding: 40px 20px;
    text-align: center;
    color: var(--muted);
    font-size: 0.7rem;
    letter-spacing: 1px;
    grid-column: 1 / -1;
  }

  /* ── MARKER ── */
  .custom-marker {
    width: 28px; height: 28px;
    border-radius: 50% 50% 50% 0;
    transform: rotate(-45deg);
    border: 2px solid white;
    box-shadow: 0 2px 7px rgba(0,0,0,0.32);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    cursor: pointer;
  }
  .custom-marker span { transform: rotate(45deg); display: block; line-height: 1; }

  /* ── POPUP ── */
  .leaflet-popup-content-wrapper {
    border-radius: 3px;
    font-family: 'IBM Plex Mono', monospace;
    box-shadow: 0 4px 20px rgba(0,0,0,0.18);
    border: 1px solid var(--border);
    background: var(--white);
    padding: 0;
    overflow: hidden;
  }

  .leaflet-popup-content {
    margin: 0 !important;
    width: 230px !important;
  }

  .popup-img {
    width: 100%;
    height: 128px;
    object-fit: cover;
    display: block;
  }

  .popup-body { padding: 11px 13px 13px; }

  .popup-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 3px;
    margin-bottom: 6px;
  }

  .popup-tag {
    font-size: 0.53rem;
    letter-spacing: 1px;
    text-transform: uppercase;
    padding: 2px 6px;
    border-radius: 1px;
    color: white;
  }

  .popup-city {
    font-size: 0.56rem;
    color: var(--muted);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    margin-bottom: 2px;
  }

  .popup-name {
    font-family: 'Playfair Display', serif;
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--ink);
    margin-bottom: 5px;
    line-height: 1.3;
  }

  .popup-note {
    font-size: 0.62rem;
    color: var(--muted);
    line-height: 1.5;
    margin-bottom: 7px;
  }

  .popup-link {
    font-size: 0.58rem;
    color: var(--gold);
    text-decoration: none;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 1px solid var(--gold-light);
  }

  .leaflet-popup-close-button {
    top: 5px !important;
    right: 6px !important;
    color: white !important;
    font-size: 16px !important;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
  }

  .leaflet-popup-tip-container { display: none; }

  /* ── RESPONSIVE ── */
  @media (max-width: 720px) {
    html, body { overflow: auto; height: auto; }
    .main { flex-direction: column; height: auto; overflow: visible; }
    #map { height: 55vw; min-height: 260px; flex: none; }
    .sidebar { width: 100%; min-width: 0; border-left: none; border-top: 1px solid var(--border); max-height: 50vh; }
    .main.is-list { flex-direction: column; }
    .main.is-list .sidebar { max-height: none; overflow-y: auto; }
    .main.is-list .sidebar-scroll { grid-template-columns: 1fr; }
    .controls { padding: 8px 14px; }
    .header-inner { padding: 11px 14px; }
  }
</style>
</head>
<body>

<header>
  <div class="header-chess-bg"></div>
  <div class="header-inner">
    <span class="king-icon">♚</span>
    <div class="header-title">
      <h1>Chess Scenes</h1>
      <div class="subtitle">IRL Chess but on a map</div>
    </div>
  </div>
</header>

<div class="controls" id="controls">
  <span class="filter-label">Filter</span>
  <div id="filter-buttons"></div>
  <div class="controls-right">
    <span id="count-badge"></span>
    <button class="suggest-btn" id="btn-suggest">+ Suggest a place</button>
    <div class="view-toggle">
      <button class="view-btn active" id="btn-map" title="Map view">⊞</button>
      <button class="view-btn" id="btn-list" title="Grid view">☰</button>
    </div>
  </div>
</div>

<div class="city-controls" id="city-controls">
  <span class="filter-label">City</span>
  <select class="city-select" id="city-select">
    <option value="">All cities</option>
  </select>
</div>

<div class="day-controls" id="day-controls">
  <span class="filter-label">Day</span>
  <div id="day-buttons"></div>
</div>

<!-- Submission Modal -->
<div class="modal-backdrop" id="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h2>♟ Suggest a Place</h2>
      <button class="modal-close" id="modal-close">✕</button>
    </div>
    <div class="modal-body">
      <p>Know a chess bar, club, or outdoor board that should be on the map? Submit it below and we'll review it before adding it to the site.</p>
      <form id="suggest-form" action="https://formspree.io/f/mwvnjbby" method="POST">
        <div class="form-row">
          <label>Place name <span class="req">*</span></label>
          <input type="text" name="name" required placeholder="e.g. Café de la Paix">
        </div>
        <div class="form-row">
          <label>City <span class="req">*</span></label>
          <input type="text" name="city" required placeholder="e.g. Paris">
        </div>
        <div class="form-row">
          <label>Type <span class="req">*</span></label>
          <div class="toggle-group" id="type-toggles" data-name="labels">
            <button type="button" class="toggle-btn" data-value="chess bar">♞ Bar</button>
            <button type="button" class="toggle-btn" data-value="chess club">♜ Club</button>
            <button type="button" class="toggle-btn" data-value="chess meetup">♝ Meetup</button>
            <button type="button" class="toggle-btn" data-value="chess board">♟ Outdoor Board</button>
            <button type="button" class="toggle-btn" data-value="chess shop">♛ Shop</button>
            <button type="button" class="toggle-btn" data-value="chess memorial">♔ Memorial</button>
          </div>
          <input type="hidden" name="labels" id="labels-hidden">
        </div>
        <div class="form-row">
          <label>Google Maps link</label>
          <input type="url" name="link" placeholder="https://maps.app.goo.gl/…">
        </div>
        <div class="form-row">
          <label>Days active <span class="form-hint">— leave blank if every day</span></label>
          <div class="toggle-group" id="day-toggles" data-name="days">
            <button type="button" class="toggle-btn" data-value="Monday">Mon</button>
            <button type="button" class="toggle-btn" data-value="Tuesday">Tue</button>
            <button type="button" class="toggle-btn" data-value="Wednesday">Wed</button>
            <button type="button" class="toggle-btn" data-value="Thursday">Thu</button>
            <button type="button" class="toggle-btn" data-value="Friday">Fri</button>
            <button type="button" class="toggle-btn" data-value="Saturday">Sat</button>
            <button type="button" class="toggle-btn" data-value="Sunday">Sun</button>
          </div>
          <input type="hidden" name="days" id="days-hidden">
        </div>
        <div class="form-row">
          <label>Notes</label>
          <textarea name="note" placeholder="Any useful details — times, what to expect, etc."></textarea>
        </div>
        <!-- Honeypot anti-spam -->
        <input type="text" name="_gotcha" style="display:none" tabindex="-1" autocomplete="off">
        <button type="submit" class="form-submit" id="form-submit">Submit for review</button>
        <div class="form-msg" id="form-msg"></div>
      </form>
    </div>
  </div>
</div>

<div class="main" id="main">
  <div id="map"></div>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">Locations</div>
    <div class="sidebar-scroll" id="list-items"></div>
  </div>
</div>

<script>
// ─── LABEL CONFIG ─────────────────────────────────────────────────────────────
const LABEL_CONFIG = {
  'chess board':    { color: '#2d6a4f', icon: '♟', display: 'Board' },
  'chess shop':     { color: '#1d4e89', icon: '♛', display: 'Shop' },
  'chess memorial': { color: '#6b2d6b', icon: '♔', display: 'Memorial' },
  'chess bar':      { color: '#8b2500', icon: '♞', display: 'Bar' },
  'chess club':     { color: '#5c4a00', icon: '♜', display: 'Club' },
  'chess meetup':   { color: '#0a5c6b', icon: '♝', display: 'Meetup' },
};

const DAYS_ORDER = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];

// Fallback for unknown labels
function labelColor(l) { return (LABEL_CONFIG[l] || {}).color || '#666'; }
function labelIcon(l)  { return (LABEL_CONFIG[l] || {}).icon  || '♟'; }
function labelDisplay(l) { return (LABEL_CONFIG[l] || {}).display || l.replace('chess ', ''); }

// Today's weekday name
const TODAY = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][new Date().getDay()];

// ─── PARSE DATA FROM HTML COMMENT ─────────────────────────────────────────────
function parseLocations() {
  const walk = document.createTreeWalker(document.documentElement, NodeFilter.SHOW_COMMENT);
  let node, raw = '';
  while ((node = walk.nextNode())) {
    if (node.nodeValue.includes('LOCATION DATA')) { raw = node.nodeValue; break; }
  }
  if (!raw) return [];

  const locations = [];
  const blocks = raw.split(/\n[ \t]*\n/);

  for (const block of blocks) {
    const lines = block.split('\n').map(l => l.trim()).filter(Boolean);
    if (!lines.some(l => /^name:/i.test(l))) continue;

    const obj = {};
    for (const line of lines) {
      const m = line.match(/^(\w+)\s*:\s*(.+)/);
      if (!m) continue;
      obj[m[1].toLowerCase()] = m[2].trim();
    }
    if (!obj.name || !obj.coordinates) continue;

    const [lat, lng] = obj.coordinates.split(',').map(Number);
    if (isNaN(lat) || isNaN(lng)) continue;

    const rawLabels = obj.labels || obj.label || '';
    const labels = rawLabels.split(',').map(s => s.trim()).filter(Boolean);

    // Parse days — null means "no restriction / always active"
    const rawDays = obj.days || obj.day || '';
    const days = rawDays
      ? rawDays.split(',').map(s => s.trim()).filter(Boolean)
      : null;

    locations.push({
      name: obj.name,
      labels,
      days,       // null = always; array = specific days
      lat, lng,
      note: obj.note || '',
      link: (obj.link && obj.link.startsWith('http')) ? obj.link : '',
      image: obj.image || '',
      city: obj.city || '',
    });
  }
  return locations;
}

const LOCATIONS = parseLocations();

// ─── COLLECT ALL UNIQUE LABELS ────────────────────────────────────────────────
const ALL_LABELS = [];
const seenLabels = new Set();
for (const loc of LOCATIONS) {
  for (const l of loc.labels) {
    if (!seenLabels.has(l)) { seenLabels.add(l); ALL_LABELS.push(l); }
  }
}

// ─── STATE ────────────────────────────────────────────────────────────────────
const activeLabels = new Set();
const activeDays   = new Set();
let activeCity = '';
let currentView = 'map';
let markerObjects = [];

// ─── MAP SETUP ────────────────────────────────────────────────────────────────
const map = L.map('map', { zoomControl: true }).setView([30, 10], 2);

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
  subdomains: 'abcd', maxZoom: 19
}).addTo(map);

// ─── BUILD CITY FILTER ────────────────────────────────────────────────────────
function buildCityFilter() {
  const cities = [...new Set(LOCATIONS.map(l => l.city).filter(Boolean))].sort();
  const sel = document.getElementById('city-select');
  for (const city of cities) {
    const opt = document.createElement('option');
    opt.value = city;
    opt.textContent = city;
    sel.appendChild(opt);
  }
  sel.addEventListener('change', () => {
    activeCity = sel.value;
    render(false);
  });
}

// ─── BUILD LABEL FILTER BUTTONS ───────────────────────────────────────────────
function buildFilters() {
  const container = document.getElementById('filter-buttons');
  container.style.cssText = 'display:flex;gap:7px;flex-wrap:wrap;align-items:center';

  for (const label of ALL_LABELS) {
    const cfg = LABEL_CONFIG[label] || {};
    const btn = document.createElement('button');
    btn.className = 'filter-btn';
    btn.dataset.label = label;
    btn.innerHTML = `<span class="dot" style="background:${cfg.color || '#888'}"></span>${labelDisplay(label)}`;
    btn.addEventListener('click', () => {
      activeLabels.has(label) ? activeLabels.delete(label) : activeLabels.add(label);
      btn.classList.toggle('active', activeLabels.has(label));
      render(false);
    });
    container.appendChild(btn);
  }
}

// ─── BUILD DAY FILTER BUTTONS ─────────────────────────────────────────────────
function buildDayFilters() {
  const container = document.getElementById('day-buttons');
  container.style.cssText = 'display:flex;gap:7px;flex-wrap:wrap;align-items:center';

  for (const day of DAYS_ORDER) {
    const btn = document.createElement('button');
    btn.className = 'filter-btn' + (day === TODAY ? ' today-btn' : '');
    btn.dataset.day = day;
    // Show a subtle dot for today even when not active
    btn.innerHTML = day === TODAY ? `${day} ·` : day;
    btn.title = day === TODAY ? `Today is ${day}` : day;
    btn.addEventListener('click', () => {
      activeDays.has(day) ? activeDays.delete(day) : activeDays.add(day);
      btn.classList.toggle('active', activeDays.has(day));
      render(false);
    });
    container.appendChild(btn);
  }
}

// ─── FILTER LOGIC ─────────────────────────────────────────────────────────────
function locMatchesFilters(loc) {
  // Label filter: if any active labels, location must match at least one
  if (activeLabels.size > 0 && !loc.labels.some(l => activeLabels.has(l))) return false;

  // Day filter: if any active days selected, location must be active on at least one
  if (activeDays.size > 0) {
    // null days = always active, passes any day filter
    if (loc.days !== null && !loc.days.some(d => activeDays.has(d))) return false;
  }

  // City filter
  if (activeCity && loc.city !== activeCity) return false;

  return true;
}

function getFiltered() {
  return LOCATIONS.filter(locMatchesFilters);
}

// ─── MARKER ICON ──────────────────────────────────────────────────────────────
function makeIcon(labels) {
  const primary = labels[0] || '';
  const color = labelColor(primary);
  const icon = labelIcon(primary);
  return L.divIcon({
    className: '',
    html: `<div class="custom-marker" style="background:${color}"><span>${icon}</span></div>`,
    iconSize: [28, 28],
    iconAnchor: [9, 28],
    popupAnchor: [5, -24],
  });
}

// ─── DAY BADGE HTML ───────────────────────────────────────────────────────────
function dayBadgesHtml(days, cssClass) {
  if (!days) return '';
  return days.map(d => {
    const cls = d === TODAY ? `${cssClass} is-today` : cssClass;
    return `<span class="${cls}">${d}</span>`;
  }).join('');
}

// ─── POPUP HTML ───────────────────────────────────────────────────────────────
function buildPopup(loc) {
  const tags = loc.labels.map(l =>
    `<span class="popup-tag" style="background:${labelColor(l)}">${labelDisplay(l)}</span>`
  ).join('');

  const dayHtml = loc.days
    ? `<div class="popup-days">${dayBadgesHtml(loc.days, 'popup-day')}</div>`
    : '';

  return `
    ${loc.image ? `<img class="popup-img" src="${loc.image}" alt="${loc.name}" loading="lazy">` : ''}
    <div class="popup-body">
      <div class="popup-tags">${tags}</div>
      ${loc.city ? `<div class="popup-city">${loc.city}</div>` : ''}
      <div class="popup-name">${loc.name}</div>
      ${loc.note ? `<div class="popup-note">${loc.note}</div>` : ''}
      ${dayHtml}
      ${loc.link ? `<a href="${loc.link}" target="_blank" rel="noopener" class="popup-link">Open in Maps ↗</a>` : ''}
    </div>`;
}

// ─── CARD HTML ────────────────────────────────────────────────────────────────
function buildCard(loc, idx) {
  const tags = loc.labels.map(l =>
    `<span class="card-tag" style="background:${labelColor(l)}">${labelDisplay(l)}</span>`
  ).join('');

  const dayHtml = loc.days
    ? `<div class="card-days">${dayBadgesHtml(loc.days, 'card-day')}</div>`
    : '';

  const card = document.createElement('div');
  card.className = 'location-card';
  card.dataset.idx = idx;
  card.innerHTML = `
    <div class="card-tags">${tags}</div>
    ${loc.city ? `<div class="card-city">${loc.city}</div>` : ''}
    <div class="card-name">${loc.name}</div>
    ${loc.note ? `<div class="card-note">${loc.note}</div>` : ''}
    ${dayHtml}
    ${loc.link ? `<a href="${loc.link}" target="_blank" rel="noopener" class="card-link" onclick="event.stopPropagation()">Open in Maps ↗</a>` : ''}
  `;
  return card;
}

// ─── RENDER ───────────────────────────────────────────────────────────────────
function render(fitBounds = true) {
  const filtered = getFiltered();

  document.getElementById('count-badge').textContent =
    `${filtered.length} place${filtered.length !== 1 ? 's' : ''}`;

  markerObjects.forEach(({ marker }) => map.removeLayer(marker));
  markerObjects = [];

  const listEl = document.getElementById('list-items');
  listEl.innerHTML = '';

  if (filtered.length === 0) {
    listEl.innerHTML = '<div class="no-results">No locations match the current filters.</div>';
    return;
  }

  filtered.forEach((loc, i) => {
    const marker = L.marker([loc.lat, loc.lng], { icon: makeIcon(loc.labels) })
      .addTo(map)
      .bindPopup(buildPopup(loc), { maxWidth: 250 });

    marker.on('popupopen', () => highlightCard(i));
    marker.on('click', () => { if (currentView === 'map') highlightCard(i); });

    markerObjects.push({ marker, locIndex: i });

    const card = buildCard(loc, i);
    card.addEventListener('click', () => {
      if (currentView === 'map') {
        map.setView([loc.lat, loc.lng], 15, { animate: true });
        marker.openPopup();
      }
      highlightCard(i);
    });
    listEl.appendChild(card);
  });

  if (fitBounds && currentView === 'map') {
    const bounds = L.latLngBounds(filtered.map(l => [l.lat, l.lng]));
    map.fitBounds(bounds, { padding: [40, 40], maxZoom: 16 });
  }
}

function highlightCard(i) {
  document.querySelectorAll('.location-card').forEach(c => c.classList.remove('highlighted'));
  const card = document.querySelector(`.location-card[data-idx="${i}"]`);
  if (card) {
    card.classList.add('highlighted');
    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

// ─── VIEW TOGGLE ──────────────────────────────────────────────────────────────
const mainEl = document.getElementById('main');

function setView(view) {
  currentView = view;
  if (view === 'map') {
    mainEl.classList.remove('is-list');
    document.body.classList.remove('is-list');
    document.getElementById('btn-map').classList.add('active');
    document.getElementById('btn-list').classList.remove('active');
    setTimeout(() => {
      map.invalidateSize();
      // Pan to city-filtered locations if a city is selected
      const filtered = getFiltered();
      if (filtered.length > 0) {
        const bounds = L.latLngBounds(filtered.map(l => [l.lat, l.lng]));
        map.fitBounds(bounds, { padding: [40, 40], maxZoom: 16 });
      }
    }, 50);
  } else {
    mainEl.classList.add('is-list');
    document.body.classList.add('is-list');
    document.getElementById('btn-list').classList.add('active');
    document.getElementById('btn-map').classList.remove('active');
  }
}

document.getElementById('btn-map').addEventListener('click', () => setView('map'));
document.getElementById('btn-list').addEventListener('click', () => setView('list'));

// ─── MODAL & SUBMISSION ───────────────────────────────────────────────────────
const RATE_LIMIT_KEY = 'chess_scenes_submit';
const RATE_LIMIT_MAX = 3;        // max submissions
const RATE_LIMIT_WINDOW = 86400000; // per 24 hours (ms)

function getRateLimitState() {
  try {
    const raw = localStorage.getItem(RATE_LIMIT_KEY);
    return raw ? JSON.parse(raw) : { count: 0, windowStart: Date.now() };
  } catch { return { count: 0, windowStart: Date.now() }; }
}

function canSubmit() {
  const state = getRateLimitState();
  if (Date.now() - state.windowStart > RATE_LIMIT_WINDOW) return true; // window expired
  return state.count < RATE_LIMIT_MAX;
}

function recordSubmission() {
  const state = getRateLimitState();
  if (Date.now() - state.windowStart > RATE_LIMIT_WINDOW) {
    localStorage.setItem(RATE_LIMIT_KEY, JSON.stringify({ count: 1, windowStart: Date.now() }));
  } else {
    localStorage.setItem(RATE_LIMIT_KEY, JSON.stringify({ count: state.count + 1, windowStart: state.windowStart }));
  }
}

const backdrop = document.getElementById('modal-backdrop');
const form     = document.getElementById('suggest-form');
const msgEl    = document.getElementById('form-msg');
const submitBtn = document.getElementById('form-submit');

document.getElementById('btn-suggest').addEventListener('click', () => {
  msgEl.className = 'form-msg';
  msgEl.textContent = '';
  backdrop.classList.add('open');
});

document.getElementById('modal-close').addEventListener('click', () => {
  backdrop.classList.remove('open');
});

backdrop.addEventListener('click', e => {
  if (e.target === backdrop) backdrop.classList.remove('open');
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') backdrop.classList.remove('open');
});

// Wire up toggle button groups (multi-select → hidden input)
document.querySelectorAll('.toggle-group').forEach(group => {
  const hidden = document.getElementById(group.id.replace('-toggles', '-hidden'));
  group.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      btn.classList.toggle('active');
      const selected = [...group.querySelectorAll('.toggle-btn.active')]
        .map(b => b.dataset.value);
      hidden.value = selected.join(', ');
    });
  });
});

form.addEventListener('submit', async e => {
  e.preventDefault();

  if (!canSubmit()) {
    msgEl.className = 'form-msg warn';
    msgEl.textContent = 'You\'ve reached the submission limit for today. Please try again tomorrow.';
    return;
  }

  // Honeypot check
  if (form.querySelector('[name="_gotcha"]').value) return;

  // Require at least one type
  if (!document.getElementById('labels-hidden').value) {
    msgEl.className = 'form-msg error';
    msgEl.textContent = 'Please select at least one type.';
    msgEl.style.display = 'block';
    return;
  }

  submitBtn.disabled = true;
  submitBtn.textContent = 'Sending…';

  try {
    const res = await fetch(form.action, {
      method: 'POST',
      body: new FormData(form),
      headers: { 'Accept': 'application/json' }
    });

    if (res.ok) {
      recordSubmission();
      msgEl.className = 'form-msg success';
      msgEl.textContent = 'Thanks! Your suggestion has been submitted for review.';
      form.reset();
      submitBtn.textContent = 'Submitted ✓';
    } else {
      throw new Error('Server error');
    }
  } catch {
    msgEl.className = 'form-msg error';
    msgEl.textContent = 'Something went wrong. Please try again or reach out directly.';
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit for review';
  }
});

// ─── INIT ─────────────────────────────────────────────────────────────────────
buildCityFilter();
buildFilters();
buildDayFilters();
render(true);
</script>
</body>
</html>
